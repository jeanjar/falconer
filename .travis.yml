language: php
php:
  - 5.5
  - 5.4

before_install:
  - sudo apt-get update -qq
  - sudo apt-get install -y php5-dev php5-mysql gcc libpcre3-dev

before_script:
  - git clone --depth=1 git://github.com/phalcon/cphalcon.git
  - (cd cphalcon/ext; export CFLAGS="-g3 -O1 -fno-delete-null-pointer-checks -Wall"; phpize && ./configure --enable-phalcon && make -j4 && sudo make install && phpenv config-add ../unit-tests/ci/phalcon.ini)
  - travis_retry composer self-update
  - travis_retry composer install --prefer-source --no-interaction --dev

script: ZEND_DONT_UNLOAD_MODULES=1 $(phpenv which php) ./tests/Falconer/ci/phpunit.php --debug -c tests/Falconer/phpunit.xml

after_script:
  - $(phpenv which php) ./tests/Falconer/ci/phpunit.php --coverage-clover build/logs/clover.xml -c tests/Falconer/phpunit.xml
  - CODECLIMATE_REPO_TOKEN=7f19265c4c7fee33becca97f8b50c7e0fc81871ed37137c47f79fd17b16842d9 ./vendor/bin/test-reporter --stdout > codeclimate.json 
  - curl -X POST -d @codeclimate.json -H 'Content-Type: application/json' -H 'User-Agent: Code Climate (PHP Test Reporter v0.1.1)' https://codeclimate.com/test_reports

notifications:
  on_success: always
  on_failure: always
